Bootstrap: docker
From: centos:7.6.1810
Stage: build

%post
mkdir aermet_demo
cd aermet_demo

mkdir build
cd build

# install packages
yum install -y wget
yum install -y unzip
yum install -y glibc-static
yum install -y centos-release-scl
yum install -y devtoolset-8-gcc devtoolset-8-gcc-c++ devtoolset-8-gcc-gfortran
scl enable devtoolset-8 -- bash

# download executable and compiler
wget --no-check-certificate https://github.com/kaufman-lab/AERMET/blob/main/aermet_source.zip?raw=true
mv aermet_source.zip\?raw\=true aermet_source.zip
unzip aermet_source.zip

wget --no-check-certificate https://github.com/kaufman-lab/AERMET/blob/main/compile.sh?raw=true
mv compile.sh\?raw\=true compile.sh

# download files
cd ../

wget --no-check-certificate https://github.com/kaufman-lab/AERMET/blob/main/SURF_DAT?raw=true
mv SURF_DAT\?raw\=true SURF_DAT

wget --no-check-certificate https://github.com/kaufman-lab/AERMET/blob/main/UP_AIR?raw=true
mv UP_AIR\?raw\=true UP_AIR

wget --no-check-certificate https://github.com/kaufman-lab/AERMET/blob/main/S1.INP?raw=true
mv S1.INP\?raw\=true S1.INP

wget --no-check-certificate https://github.com/kaufman-lab/AERMET/blob/main/S2.INP?raw=true
mv S2.INP\?raw\=true S2.INP

wget --no-check-certificate https://github.com/kaufman-lab/AERMET/blob/main/S3.INP?raw=true
mv S3.INP\?raw\=true S3.INP


# compile aermet executable
export PATH=/opt/rh/devtoolset-8/root/bin:$PATH #should make gcc command work
export LD_LIBRARY_PATH=/opt/rh/devtoolset-8/root/lib/gcc/x86_64-redhat-linux:$LD_LIBRARY_PATH #hopefully add libraries like libgfortran

cd build
sh compile.sh

cd ../
ln -s build/aermet.exe 

# stage 1 
./aermet.exe S1.INP

# stage 2
./aermet.exe S2.INP

# stage 3
./aermet.exe S3.INP

%environment
export PATH=/opt/rh/devtoolset-8/root/bin:$PATH #should make gcc command work
export LD_LIBRARY_PATH=/opt/rh/devtoolset-8/root/lib/gcc/x86_64-redhat-linux:$LD_LIBRARY_PATH #hopefully add libraries like libgfortran
